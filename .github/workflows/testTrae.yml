# SkyWalking Showcase 镜像构建和推送工作流
# 支持手动执行和issue评论触发，推送到阿里云容器服务

name: Build and Push to Alibaba Cloud

# 触发条件：仅手动执行
on:
  workflow_dispatch:
    inputs:
      services:
        description: '要构建的服务 (用逗号分隔，留空构建所有服务)'
        required: false
        default: ''
      tag:
        description: '镜像标签'
        required: false
        default: 'latest'
      push_to_registry:
        description: '是否推送到阿里云容器服务'
        type: boolean
        required: false
        default: true

# 环境变量配置
env:
  # 阿里云容器镜像服务配置
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}  # 例如: your-registry.cn-hangzhou.cr.aliyuncs.com
  ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }} # 例如: skywalking-showcase
  
  # SkyWalking Agent版本配置
  SW_AGENT_NODEJS_FRONTEND_VERSION: dce0d5b39ab95b8062031bc74e6f7a191f08e186
  SW_AGENT_NODEJS_BACKEND_VERSION: 59ef1aed6a404e2e8afffbb4b81ea849ae4f3026
  SW_AGENT_GO_IMAGE: ghcr.io/apache/skywalking-go/skywalking-go:154de50628e82e590941585411299459e352317d-go1.19
  SW_AGENT_JAVA_IMAGE: ghcr.io/apache/skywalking-java/skywalking-java:26ef911aea908759795bb6f5f2f6be56370d30cc-java8
  
  # 构建配置
  DOCKER_BUILDKIT: 1

# 权限配置
permissions:
  contents: read

jobs:
  # 准备构建矩阵
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 设置构建矩阵
        id: set-matrix
        run: |
          # 定义所有可用的服务
          ALL_SERVICES='["app/frontend", "app/server", "gateway-service", "rating-service", "recommendation-service", "songs-service", "load-gen"]'
          
          # 检查是否指定了特定服务
          if [ "${{ github.event.inputs.services }}" != "" ]; then
            # 手动指定的服务
            SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -R 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$"; ""))')
            echo "构建指定服务: $SERVICES"
          else
            # 默认构建所有服务
            SERVICES=$ALL_SERVICES
            echo "构建所有服务"
          fi
          
          echo "matrix=$SERVICES" >> $GITHUB_OUTPUT
          
      - name: 设置镜像标签
        id: set-tag
        run: |
          if [ "${{ github.event.inputs.tag }}" != "" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_SHA:0:8}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "使用镜像标签: $TAG"

  # 构建和推送镜像
  build:
    needs: prepare
    if: needs.prepare.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史用于构建SkyWalking Agent
          
      - name: 设置Java环境 (仅Java服务)
        if: contains(fromJson('["gateway-service", "recommendation-service", "songs-service"]'), matrix.service)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'
          
      - name: 构建Java应用 (仅Java服务)
        if: contains(fromJson('["gateway-service", "recommendation-service", "songs-service"]'), matrix.service)
        run: |
          cd services/${{ matrix.service }}
          chmod +x gradlew
          ./gradlew build -x test
          
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          
      - name: 登录阿里云容器镜像服务
        if: github.event.inputs.push_to_registry != 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
          
      - name: 提取镜像元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ matrix.service }}
          tags: |
            type=raw,value=${{ needs.prepare.outputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            
      - name: 构建镜像 (仅测试)
        if: github.event.inputs.push_to_registry == 'false'
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          platforms: linux/amd64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            SW_AGENT_NODEJS_FRONTEND_VERSION=${{ env.SW_AGENT_NODEJS_FRONTEND_VERSION }}
            SW_AGENT_NODEJS_BACKEND_VERSION=${{ env.SW_AGENT_NODEJS_BACKEND_VERSION }}
            SW_AGENT_GO_IMAGE=${{ env.SW_AGENT_GO_IMAGE }}
            SW_AGENT_JAVA_IMAGE=${{ env.SW_AGENT_JAVA_IMAGE }}
            
      - name: 构建并推送镜像
        if: github.event.inputs.push_to_registry != 'false'
        uses: docker/build-push-action@v5
        id: build
        with:
          context: ./services/${{ matrix.service }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            SW_AGENT_NODEJS_FRONTEND_VERSION=${{ env.SW_AGENT_NODEJS_FRONTEND_VERSION }}
            SW_AGENT_NODEJS_BACKEND_VERSION=${{ env.SW_AGENT_NODEJS_BACKEND_VERSION }}
            SW_AGENT_GO_IMAGE=${{ env.SW_AGENT_GO_IMAGE }}
            SW_AGENT_JAVA_IMAGE=${{ env.SW_AGENT_JAVA_IMAGE }}
            
      - name: 输出构建结果
        run: |
          echo "## 🐳 镜像构建完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**服务:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**标签:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**镜像:** ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ matrix.service }}:${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.push_to_registry }}" != "false" ]; then
            echo "**状态:** ✅ 已推送到阿里云容器服务" >> $GITHUB_STEP_SUMMARY
          else
            echo "**状态:** 🔍 仅构建测试，未推送" >> $GITHUB_STEP_SUMMARY
          fi

  # 汇总构建结果
  summary:
    needs: [prepare, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: 生成构建报告
        run: |
          echo "# 🚀 SkyWalking Showcase 构建报告" > build-report.md
          echo "" >> build-report.md
          echo "**构建时间:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-report.md
          echo "**触发方式:** ${{ github.event_name }}" >> build-report.md
          echo "**分支/PR:** ${{ github.ref_name }}" >> build-report.md
          echo "**提交:** ${{ github.sha }}" >> build-report.md
          echo "**镜像标签:** ${{ needs.prepare.outputs.tag }}" >> build-report.md
          echo "" >> build-report.md
          
          # 构建状态
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "## ✅ 构建成功" >> build-report.md
            echo "" >> build-report.md
            echo "所有服务镜像构建完成！" >> build-report.md
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            echo "## ❌ 构建失败" >> build-report.md
            echo "" >> build-report.md
            echo "部分服务构建失败，请检查构建日志。" >> build-report.md
          else
            echo "## ⚠️ 构建被跳过" >> build-report.md
            echo "" >> build-report.md
            echo "没有检测到需要构建的服务变更。" >> build-report.md
          fi
          
          echo "" >> build-report.md
          echo "## 📋 构建的服务" >> build-report.md
          echo "" >> build-report.md
          
          # 显示构建的服务列表
          SERVICES='${{ needs.prepare.outputs.matrix }}'
          if [ "$SERVICES" != "[]" ]; then
            echo "$SERVICES" | jq -r '.[] | "- " + .'
          else
            echo "- 无服务需要构建"
          fi >> build-report.md
          
          echo "" >> build-report.md
          echo "## 🔗 镜像地址" >> build-report.md
          echo "" >> build-report.md
          
          if [ "${{ github.event.inputs.push_to_registry }}" != "false" ]; then
            echo "镜像已推送到阿里云容器服务：" >> build-report.md
            echo "" >> build-report.md
            echo "\`\`\`" >> build-report.md
            echo "$SERVICES" | jq -r '.[] | "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/" + . + ":${{ needs.prepare.outputs.tag }}"' >> build-report.md
            echo "\`\`\`" >> build-report.md
          else
            echo "镜像仅构建测试，未推送到注册表。" >> build-report.md
          fi
          
          # 输出到GitHub Summary
          cat build-report.md >> $GITHUB_STEP_SUMMARY
          
      - name: 保存构建报告
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30
