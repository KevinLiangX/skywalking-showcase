name: build-service-app-images

on:
  issue_comment:
    types: [created, edited]

jobs:
  build-image:
    # 仅处理以 "/build" 开头的评论
    if: |
      startsWith(github.event.comment.body, '/build') &&
      github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    environment: Production
    
    permissions:
      contents: read
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Parse build command
      id: parse-command
      run: |
        COMMENT="${{ github.event.comment.body }}"
        
        # 提取参数：/build [service] [tag] [dockerfile]
        SERVICE=$(echo "$COMMENT" | awk '/\/build/ {print $2}')
        TAG=$(echo "$COMMENT" | awk '/\/build/ {print $3}')
        DOCKERFILE=$(echo "$COMMENT" | awk '/\/build/ {print $4}')
        
        # 设置默认值
        [[ -z "$SERVICE" ]] && SERVICE="app"
        [[ -z "$TAG" ]] && TAG="latest"
        [[ -z "$DOCKERFILE" ]] && DOCKERFILE="$SERVICE/Dockerfile"
        
        # 验证服务目录是否存在
        if [ ! -d "$SERVICE" ]; then
          echo "::error ::服务目录 '$SERVICE' 不存在"
          exit 1
        fi
        
        echo "service=$SERVICE" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "dockerfile=$DOCKERFILE" >> $GITHUB_OUTPUT

    # 登录阿里云容器镜像服务
    - name: Login to Aliyun ACR
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
        
    # 构建并推送到阿里云ACR
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./${{ steps.parse-command.outputs.service }}
        file: ./${{ steps.parse-command.outputs.dockerfile }}
        push: true
        tags: |
          ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ steps.parse-command.outputs.service }}:${{ steps.parse-command.outputs.tag }}
          ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ steps.parse-command.outputs.service }}:latest
        
    - name: Add build comment
      uses: actions/github-script@v7
      env:
        SERVICE: ${{ steps.parse-command.outputs.service }}
        TAG: ${{ steps.parse-command.outputs.tag }}
        IMAGE_URL: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ steps.parse-command.outputs.service }}:${{ steps.parse-command.outputs.tag }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: ${{ github.event.issue.number }},
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `✅ 镜像已成功推送到阿里云ACR！\n` +
                   `**服务**: ${process.env.SERVICE}\n` +
                   `**标签**: ${process.env.TAG}\n` +
                   `**镜像地址**: \`${process.env.IMAGE_URL}\`\n` +
                   `**拉取命令**: \`docker pull ${process.env.IMAGE_URL}\``
          });
