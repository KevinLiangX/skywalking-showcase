name: Build and Push to Aliyun Container Registry

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      services:
        description: 'è¦æ„å»ºçš„æœåŠ¡ (ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºè¡¨ç¤ºæ„å»ºæ‰€æœ‰æœåŠ¡)'
        required: false
        default: 'all'
      tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: ''
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡'
        required: true
        default: true
        type: boolean
      
  issue_comment:  # issue comment è§¦å‘
    types: [created]

env:
  # é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡é…ç½®
  ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: skywalking-showcase  # ä¿®æ”¹ä¸ºæ‚¨çš„å‘½åç©ºé—´
  
  # æ„å»ºé…ç½®
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  # æ£€æŸ¥è§¦å‘æ¡ä»¶
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      services: ${{ steps.check.outputs.services }}
      tag: ${{ steps.check.outputs.tag }}
      push_enabled: ${{ steps.check.outputs.push_enabled }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          # é»˜è®¤å€¼
          SHOULD_RUN="false"
          SERVICES="all"
          TAG=""
          PUSH_ENABLED="true"
          ISSUE_NUMBER=""
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘
            SHOULD_RUN="true"
            SERVICES="${{ github.event.inputs.services }}"
            TAG="${{ github.event.inputs.tag }}"
            PUSH_ENABLED="${{ github.event.inputs.push_to_registry }}"
            echo "ğŸš€ æ‰‹åŠ¨è§¦å‘æ„å»º"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            # issue comment è§¦å‘
            COMMENT_BODY="${{ github.event.comment.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æƒé™çš„ç”¨æˆ·
            if [[ "${{ github.event.comment.author_association }}" == "OWNER" ]] || \
               [[ "${{ github.event.comment.author_association }}" == "MEMBER" ]] || \
               [[ "${{ github.event.comment.author_association }}" == "COLLABORATOR" ]]; then
              
              # æ£€æŸ¥ comment å†…å®¹
              if echo "$COMMENT_BODY" | grep -E "^/build-aliyun"; then
                SHOULD_RUN="true"
                echo "ğŸ¯ é€šè¿‡ issue comment è§¦å‘æ„å»º"
                
                # è§£æå‚æ•°
                if echo "$COMMENT_BODY" | grep -E -- "--services"; then
                  SERVICES=$(echo "$COMMENT_BODY" | sed -n 's/.*--services[= ]\([^ ]*\).*/\1/p')
                fi
                
                if echo "$COMMENT_BODY" | grep -E -- "--tag"; then
                  TAG=$(echo "$COMMENT_BODY" | sed -n 's/.*--tag[= ]\([^ ]*\).*/\1/p')
                fi
                
                if echo "$COMMENT_BODY" | grep -E -- "--no-push"; then
                  PUSH_ENABLED="false"
                fi
              fi
            else
              echo "âŒ ç”¨æˆ·æ²¡æœ‰æƒé™è§¦å‘æ„å»º"
            fi
          fi
          
          # è®¾ç½®é»˜è®¤æ ‡ç­¾
          if [[ -z "$TAG" ]]; then
            TAG="$(date +%Y%m%d-%H%M%S)-$(echo ${{ github.sha }} | cut -c1-7)"
          fi
          
          echo "should_run=${SHOULD_RUN}" >> $GITHUB_OUTPUT
          echo "services=${SERVICES}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "push_enabled=${PUSH_ENABLED}" >> $GITHUB_OUTPUT
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ æ„å»ºé…ç½®:"
          echo "  - æ˜¯å¦æ‰§è¡Œ: ${SHOULD_RUN}"
          echo "  - æœåŠ¡: ${SERVICES}"
          echo "  - æ ‡ç­¾: ${TAG}"
          echo "  - æ¨é€: ${PUSH_ENABLED}"
          echo "  - Issue: ${ISSUE_NUMBER}"

  # åœ¨ issue ä¸­æ·»åŠ å¼€å§‹æ„å»ºçš„è¯„è®º
  comment-start:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true' && needs.check-trigger.outputs.issue_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Comment on issue - Build started
        uses: actions/github-script@v7
        with:
          script: |
            const { issue_number } = context.payload;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: `## ğŸš€ æ„å»ºå¼€å§‹
              
              **æ„å»ºé…ç½®:**
              - ğŸ·ï¸ æ ‡ç­¾: \`${{ needs.check-trigger.outputs.tag }}\`
              - ğŸ“¦ æœåŠ¡: \`${{ needs.check-trigger.outputs.services }}\`
              - ğŸ“¤ æ¨é€åˆ°é˜¿é‡Œäº‘: ${{ needs.check-trigger.outputs.push_enabled == 'true' && 'âœ…' || 'âŒ' }}
              - ğŸ”— [æŸ¥çœ‹æ„å»ºè¿›åº¦](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              â³ æ„å»ºä¸­ï¼Œè¯·ç¨å€™...`
            });

  # æ„å»ºå’Œæ¨é€æœåŠ¡
  build-and-push:
    needs: [check-trigger, comment-start]
    if: always() && needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.check-trigger.outputs.services == 'all' && '["app", "gateway-service", "songs-service", "rating-service", "recommendation-service", "load-gen"]' || format('["{0}"]', needs.check-trigger.outputs.services)) }}
    outputs:
      results: ${{ steps.collect-results.outputs.results }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js (for frontend services)
        if: matrix.service == 'app'
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'services/app/frontend/package-lock.json'

      - name: Set up Java (for Java services)
        if: contains(fromJson('["gateway-service", "songs-service"]'), matrix.service)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Set up Go (for Go services)
        if: matrix.service == 'rating-service'
        uses: actions/setup-go@v5
        with:
          go-version: '1.19'

      - name: Set up Python (for Python services)
        if: contains(fromJson('["recommendation-service", "load-gen"]'), matrix.service)
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Log in to Aliyun Container Registry
        if: needs.check-trigger.outputs.push_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Build Docker images
        id: build
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ”¨ æ„å»ºæœåŠ¡: ${{ matrix.service }}"
          echo "ğŸ“¦ é•œåƒä»“åº“: ${HUB}"
          echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾: ${TAG}"
          
          # è¿›å…¥æœåŠ¡ç›®å½•å¹¶æ„å»º
          cd services/${{ matrix.service }}
          
          # è®¾ç½®æ„å»ºç»“æœè¾“å‡º
          BUILD_SUCCESS="false"
          BUILT_IMAGES=""
          
          if make docker.build; then
            BUILD_SUCCESS="true"
            echo "âœ… ${{ matrix.service }} æ„å»ºæˆåŠŸ"
            
            # æ”¶é›†æ„å»ºçš„é•œåƒä¿¡æ¯
            case "${{ matrix.service }}" in
              "app")
                BUILT_IMAGES="${HUB}/frontend:${TAG},${HUB}/server:${TAG}"
                if docker images | grep -q "${HUB}/frontend.*${TAG}-agentless"; then
                  BUILT_IMAGES="${BUILT_IMAGES},${HUB}/frontend:${TAG}-agentless"
                fi
                if docker images | grep -q "${HUB}/server.*${TAG}-agentless"; then
                  BUILT_IMAGES="${BUILT_IMAGES},${HUB}/server:${TAG}-agentless"
                fi
                ;;
              *)
                BUILT_IMAGES="${HUB}/${{ matrix.service }}:${TAG}"
                if docker images | grep -q "${HUB}/${{ matrix.service }}.*${TAG}-agentless"; then
                  BUILT_IMAGES="${BUILT_IMAGES},${HUB}/${{ matrix.service }}:${TAG}-agentless"
                fi
                ;;
            esac
          else
            echo "âŒ ${{ matrix.service }} æ„å»ºå¤±è´¥"
          fi
          
          echo "build_success=${BUILD_SUCCESS}" >> $GITHUB_OUTPUT
          echo "built_images=${BUILT_IMAGES}" >> $GITHUB_OUTPUT

      - name: Push Docker images
        if: steps.build.outputs.build_success == 'true' && needs.check-trigger.outputs.push_enabled == 'true'
        id: push
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ“¤ æ¨é€æœåŠ¡: ${{ matrix.service }}"
          
          cd services/${{ matrix.service }}
          
          PUSH_SUCCESS="false"
          PUSHED_IMAGES=""
          
          if make docker.push; then
            PUSH_SUCCESS="true"
            PUSHED_IMAGES="${{ steps.build.outputs.built_images }}"
            echo "âœ… ${{ matrix.service }} æ¨é€æˆåŠŸ"
          else
            echo "âŒ ${{ matrix.service }} æ¨é€å¤±è´¥"
          fi
          
          echo "push_success=${PUSH_SUCCESS}" >> $GITHUB_OUTPUT
          echo "pushed_images=${PUSHED_IMAGES}" >> $GITHUB_OUTPUT

      - name: Collect results
        id: collect-results
        run: |
          SERVICE_RESULT="{"
          SERVICE_RESULT="${SERVICE_RESULT}\"service\":\"${{ matrix.service }}\","
          SERVICE_RESULT="${SERVICE_RESULT}\"build_success\":${{ steps.build.outputs.build_success }},"
          
          if [[ "${{ needs.check-trigger.outputs.push_enabled }}" == "true" ]]; then
            SERVICE_RESULT="${SERVICE_RESULT}\"push_success\":${{ steps.push.outputs.push_success || false }},"
            SERVICE_RESULT="${SERVICE_RESULT}\"images\":\"${{ steps.push.outputs.pushed_images || steps.build.outputs.built_images }}\""
          else
            SERVICE_RESULT="${SERVICE_RESULT}\"push_success\":null,"
            SERVICE_RESULT="${SERVICE_RESULT}\"images\":\"${{ steps.build.outputs.built_images }}\""
          fi
          SERVICE_RESULT="${SERVICE_RESULT}}"
          
          echo "results=${SERVICE_RESULT}" >> $GITHUB_OUTPUT

  # æ±‡æ€»æ„å»ºç»“æœå¹¶è¯„è®º
  build-summary:
    needs: [check-trigger, build-and-push]
    if: always() && needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Prepare summary
        id: summary
        run: |
          echo "## ğŸ“Š æ„å»ºç»“æœæ±‡æ€»" > summary.md
          echo "" >> summary.md
          echo "**æ„å»ºé…ç½®:**" >> summary.md
          echo "- ğŸ·ï¸ æ ‡ç­¾: \`${{ needs.check-trigger.outputs.tag }}\`" >> summary.md
          echo "- ğŸ“¦ æœåŠ¡: \`${{ needs.check-trigger.outputs.services }}\`" >> summary.md
          echo "- ğŸ“¤ æ¨é€åˆ°é˜¿é‡Œäº‘: ${{ needs.check-trigger.outputs.push_enabled == 'true' && 'âœ… æ˜¯' || 'âŒ å¦' }}" >> summary.md
          echo "- ğŸ­ é•œåƒä»“åº“: \`${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}\`" >> summary.md
          echo "" >> summary.md
          
          # åˆ†ææ„å»ºç»“æœ
          TOTAL_SERVICES=0
          SUCCESS_SERVICES=0
          FAILED_SERVICES=""
          BUILT_IMAGES=""
          
          # è¿™é‡Œéœ€è¦è§£ææ¯ä¸ªæœåŠ¡çš„ç»“æœ
          # ç”±äº GitHub Actions çš„é™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€åŒ–çš„æ–¹å¼
          echo "### ğŸ”¨ æ„å»ºçŠ¶æ€" >> summary.md
          echo "" >> summary.md
          
          # æ£€æŸ¥æ„å»ºçŠ¶æ€
          if [[ "${{ needs.build-and-push.result }}" == "success" ]]; then
            echo "âœ… **æ‰€æœ‰æœåŠ¡æ„å»ºæˆåŠŸ**" >> summary.md
          else
            echo "âŒ **éƒ¨åˆ†æœåŠ¡æ„å»ºå¤±è´¥**" >> summary.md
          fi
          
          echo "" >> summary.md
          echo "### ğŸ“¦ æ„å»ºçš„é•œåƒ" >> summary.md
          echo "" >> summary.md
          
          # æ ¹æ®æœåŠ¡ç±»å‹åˆ—å‡ºé•œåƒ
          SERVICES="${{ needs.check-trigger.outputs.services }}"
          TAG="${{ needs.check-trigger.outputs.tag }}"
          REGISTRY="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}"
          
          if [[ "$SERVICES" == "all" ]]; then
            SERVICES="app,gateway-service,songs-service,rating-service,recommendation-service,load-gen"
          fi
          
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            case "$service" in
              "app")
                echo "- \`${REGISTRY}/frontend:${TAG}\`" >> summary.md
                echo "- \`${REGISTRY}/server:${TAG}\`" >> summary.md
                ;;
              *)
                echo "- \`${REGISTRY}/${service}:${TAG}\`" >> summary.md
                ;;
            esac
          done
          
          echo "" >> summary.md
          echo "### ğŸ“‹ ä½¿ç”¨è¯´æ˜" >> summary.md
          echo "" >> summary.md
          echo "\`\`\`bash" >> summary.md
          echo "# æ‹‰å–é•œåƒç¤ºä¾‹" >> summary.md
          echo "docker pull ${REGISTRY}/frontend:${TAG}" >> summary.md
          echo "docker pull ${REGISTRY}/gateway-service:${TAG}" >> summary.md
          echo "" >> summary.md
          echo "# è¿è¡Œç¤ºä¾‹" >> summary.md
          echo "docker run --rm ${REGISTRY}/gateway-service:${TAG}" >> summary.md
          echo "\`\`\`" >> summary.md
          
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "*æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> summary.md
          echo "*æ„å»ºID: [\`${{ github.run_id }}\`](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> summary.md

      - name: Comment on issue with results
        if: needs.check-trigger.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: summary
            });

      - name: Add to job summary
        run: |
          cat summary.md >> $GITHUB_STEP_SUMMARY

      - name: Check final status
        run: |
          if [[ "${{ needs.build-and-push.result }}" != "success" ]]; then
            echo "âŒ æ„å»ºè¿‡ç¨‹ä¸­æœ‰å¤±è´¥çš„æœåŠ¡"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æœåŠ¡æ„å»ºæˆåŠŸ!"
          fi
