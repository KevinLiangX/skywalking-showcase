name: Build Server Service Only

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: 'v1.0.0'
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡'
        required: true
        default: true
        type: boolean
      
  issue_comment:  # issue comment è§¦å‘
    types: [created]

env:
  # é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡é…ç½®
  ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: skywk-showcase  # ä½¿ç”¨æ‚¨çš„å‘½åç©ºé—´
  
  # æ„å»ºé…ç½®
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  # æ£€æŸ¥è§¦å‘æ¡ä»¶
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      tag: ${{ steps.check.outputs.tag }}
      push_enabled: ${{ steps.check.outputs.push_enabled }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          SHOULD_RUN="false"
          TAG="v1.0.0"
          PUSH_ENABLED="true"
          ISSUE_NUMBER=""
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_RUN="true"
            TAG="${{ github.event.inputs.tag }}"
            PUSH_ENABLED="${{ github.event.inputs.push_to_registry }}"
            echo "ğŸš€ æ‰‹åŠ¨è§¦å‘ server é•œåƒæ„å»º"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            
            if [[ "${{ github.event.comment.author_association }}" == "OWNER" ]] || \
               [[ "${{ github.event.comment.author_association }}" == "MEMBER" ]] || \
               [[ "${{ github.event.comment.author_association }}" == "COLLABORATOR" ]]; then
              
              if echo "$COMMENT_BODY" | grep -E "^/build-server"; then
                SHOULD_RUN="true"
                echo "ğŸ¯ é€šè¿‡ issue comment è§¦å‘ server æ„å»º"
                
                if echo "$COMMENT_BODY" | grep -E -- "--tag"; then
                  TAG=$(echo "$COMMENT_BODY" | sed -n 's/.*--tag[= ]\([^ ]*\).*/\1/p')
                fi
                
                if echo "$COMMENT_BODY" | grep -E -- "--no-push"; then
                  PUSH_ENABLED="false"
                fi
              fi
            fi
          fi
          
          echo "should_run=${SHOULD_RUN}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "push_enabled=${PUSH_ENABLED}" >> $GITHUB_OUTPUT
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT

  # æ„å»º server æœåŠ¡
  build-server:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Log in to Aliyun Container Registry
        if: needs.check-trigger.outputs.push_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Build Server Docker image
        id: build
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ”¨ æ„å»º server æœåŠ¡"
          echo "ğŸ“¦ é•œåƒä»“åº“: ${HUB}"
          echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾: ${TAG}"
          
          cd services/app/server
          
          BUILD_SUCCESS="false"
          BUILT_IMAGES=""
          
          # æ„å»º server é•œåƒ
          if make docker.build; then
            BUILD_SUCCESS="true"
            echo "âœ… server æ„å»ºæˆåŠŸ"
            BUILT_IMAGES="${HUB}/server:${TAG}"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ agentless ç‰ˆæœ¬
            if docker images | grep -q "${HUB}/server.*${TAG}-agentless"; then
              BUILT_IMAGES="${BUILT_IMAGES},${HUB}/server:${TAG}-agentless"
            fi
          else
            echo "âŒ server æ„å»ºå¤±è´¥"
          fi
          
          echo "build_success=${BUILD_SUCCESS}" >> $GITHUB_OUTPUT
          echo "built_images=${BUILT_IMAGES}" >> $GITHUB_OUTPUT

      - name: Push Server Docker image
        if: steps.build.outputs.build_success == 'true' && needs.check-trigger.outputs.push_enabled == 'true'
        id: push
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ“¤ æ¨é€ server æœåŠ¡"
          
          cd services/app/server
          
          PUSH_SUCCESS="false"
          
          if make docker.push; then
            PUSH_SUCCESS="true"
            echo "âœ… server æ¨é€æˆåŠŸ"
          else
            echo "âŒ server æ¨é€å¤±è´¥"
          fi
          
          echo "push_success=${PUSH_SUCCESS}" >> $GITHUB_OUTPUT

      - name: Comment on issue with results
        if: needs.check-trigger.outputs.issue_number != '' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildSuccess = '${{ steps.build.outputs.build_success }}' === 'true';
            const pushSuccess = '${{ steps.push.outputs.push_success }}' === 'true';
            const pushEnabled = '${{ needs.check-trigger.outputs.push_enabled }}' === 'true';
            
            let status = 'âŒ å¤±è´¥';
            let details = '';
            
            if (buildSuccess) {
              if (pushEnabled) {
                status = pushSuccess ? 'âœ… æˆåŠŸ' : 'âš ï¸ æ„å»ºæˆåŠŸï¼Œæ¨é€å¤±è´¥';
              } else {
                status = 'âœ… æ„å»ºæˆåŠŸ (æœªæ¨é€)';
              }
              
              details = `
              **æ„å»ºçš„é•œåƒ:**
              - \`${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/server:${{ needs.check-trigger.outputs.tag }}\`
              
              **ä½¿ç”¨æ–¹å¼:**
              \`\`\`bash
              # æ‹‰å–é•œåƒ
              docker pull ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/server:${{ needs.check-trigger.outputs.tag }}
              
              # åœ¨ Kubernetes ä¸­ä½¿ç”¨
              image: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/server:${{ needs.check-trigger.outputs.tag }}
              \`\`\``;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: \`## ğŸ“¦ Server é•œåƒæ„å»ºç»“æœ
              
              **çŠ¶æ€:** \${status}
              **æ ‡ç­¾:** \`${{ needs.check-trigger.outputs.tag }}\`
              **æ¨é€åˆ°é˜¿é‡Œäº‘:** \${pushEnabled ? 'âœ… æ˜¯' : 'âŒ å¦'}
              
              \${details}
              
              ---
              *æ„å»ºæ—¶é—´: \${new Date().toISOString()}*
              *æ„å»ºID: [\`${{ github.run_id }}\`](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*\`
            });

      - name: Add to job summary
        run: |
          echo "## ğŸ“¦ Server é•œåƒæ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºçŠ¶æ€:** ${{ steps.build.outputs.build_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ¨é€çŠ¶æ€:** ${{ steps.push.outputs.push_success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:** \`${{ needs.check-trigger.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºçš„é•œåƒ:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/server:${{ needs.check-trigger.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          
      - name: Check final status
        run: |
          if [[ "${{ steps.build.outputs.build_success }}" != "true" ]]; then
            echo "âŒ Server é•œåƒæ„å»ºå¤±è´¥"
            exit 1
          else
            echo "âœ… Server é•œåƒæ„å»ºæˆåŠŸ!"
            
            if [[ "${{ needs.check-trigger.outputs.push_enabled }}" == "true" ]]; then
              if [[ "${{ steps.push.outputs.push_success }}" == "true" ]]; then
                echo "âœ… Server é•œåƒæ¨é€æˆåŠŸ!"
              else
                echo "âŒ Server é•œåƒæ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          fi
