name: Build Java 8 Compatible Images (Fixed)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      services:
        description: 'è¦æ„å»ºçš„ Java æœåŠ¡ (ç”¨é€—å·åˆ†éš”)'
        required: false
        default: 'gateway-service,songs-service'
      tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: 'java8-fix-20250822'
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡'
        required: true
        default: true
        type: boolean
      
  issue_comment:  # issue comment è§¦å‘
    types: [created]

env:
  # é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡é…ç½®
  ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: skywk-showcase
  
  # æ„å»ºé…ç½®
  DOCKER_BUILDKIT: 1

jobs:
  # æ£€æŸ¥è§¦å‘æ¡ä»¶
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      services: ${{ steps.check.outputs.services }}
      tag: ${{ steps.check.outputs.tag }}
      push_enabled: ${{ steps.check.outputs.push_enabled }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          SHOULD_RUN="false"
          SERVICES="gateway-service,songs-service"
          TAG="java8-fix-20250822"
          PUSH_ENABLED="true"
          ISSUE_NUMBER=""
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_RUN="true"
            SERVICES="${{ github.event.inputs.services }}"
            TAG="${{ github.event.inputs.tag }}"
            PUSH_ENABLED="${{ github.event.inputs.push_to_registry }}"
            echo "ğŸš€ æ‰‹åŠ¨è§¦å‘ Java 8 ä¿®å¤ç‰ˆæœ¬æ„å»º"
          elif [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            COMMENT_BODY="${{ github.event.comment.body }}"
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            
            if [[ "${{ github.event.comment.author_association }}" == "OWNER" ]] || \
               [[ "${{ github.event.comment.author_association }}" == "MEMBER" ]] || \
               [[ "${{ github.event.comment.author_association }}" == "COLLABORATOR" ]]; then
              
              if echo "$COMMENT_BODY" | grep -E "^/build-java8-fix"; then
                SHOULD_RUN="true"
                echo "ğŸ¯ é€šè¿‡ issue comment è§¦å‘ Java 8 ä¿®å¤æ„å»º"
                
                if echo "$COMMENT_BODY" | grep -E -- "--tag"; then
                  TAG=$(echo "$COMMENT_BODY" | sed -n 's/.*--tag[= ]\([^ ]*\).*/\1/p')
                fi
                
                if echo "$COMMENT_BODY" | grep -E -- "--no-push"; then
                  PUSH_ENABLED="false"
                fi
              fi
            fi
          fi
          
          echo "should_run=${SHOULD_RUN}" >> $GITHUB_OUTPUT
          echo "services=${SERVICES}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "push_enabled=${PUSH_ENABLED}" >> $GITHUB_OUTPUT
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT

  # æ„å»º Java 8 å…¼å®¹çš„æœåŠ¡ (ä¿®å¤ç‰ˆæœ¬)
  build-java8-services:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(format('["{0}"]', split(needs.check-trigger.outputs.services, ','))) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Java 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Log in to Aliyun Container Registry
        if: needs.check-trigger.outputs.push_enabled == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Build Java 8 fixed Docker images
        id: build
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ”¨ æ„å»º Java 8 ä¿®å¤ç‰ˆæœ¬: ${{ matrix.service }}"
          echo "ğŸ“¦ é•œåƒä»“åº“: ${HUB}"
          echo "ğŸ·ï¸ é•œåƒæ ‡ç­¾: ${TAG}"
          
          cd services/${{ matrix.service }}
          
          BUILD_SUCCESS="false"
          BUILT_IMAGES=""
          
          # ä½¿ç”¨ä¿®å¤åçš„ Java 8 å…¼å®¹ Dockerfile
          if [[ -f "Dockerfile.java8" ]]; then
            echo "ä½¿ç”¨ä¿®å¤åçš„ Java 8 ä¸“ç”¨ Dockerfile"
            
            # è®¾ç½® buildx æ„å»ºå‚æ•°
            docker buildx build \
              --platform linux/amd64 \
              --file Dockerfile.java8 \
              --tag ${HUB}/${{ matrix.service }}:${TAG} \
              --load \
              .
            
            BUILD_SUCCESS="true"
            BUILT_IMAGES="${HUB}/${{ matrix.service }}:${TAG}"
            
            echo "âœ… ${{ matrix.service }} æ„å»ºæˆåŠŸ"
            
            # éªŒè¯é•œåƒä¸­çš„ Java å¯ç”¨æ€§
            echo "ğŸ” éªŒè¯ Java 8 å®‰è£…..."
            docker run --rm ${HUB}/${{ matrix.service }}:${TAG} java -version || true
            
          else
            echo "âŒ æ‰¾ä¸åˆ° Dockerfile.java8"
            exit 1
          fi
          
          echo "build_success=${BUILD_SUCCESS}" >> $GITHUB_OUTPUT
          echo "built_images=${BUILT_IMAGES}" >> $GITHUB_OUTPUT

      - name: Push Docker images
        if: steps.build.outputs.build_success == 'true' && needs.check-trigger.outputs.push_enabled == 'true'
        id: push
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ“¤ æ¨é€æœåŠ¡: ${{ matrix.service }}"
          
          PUSH_SUCCESS="false"
          
          if docker push ${HUB}/${{ matrix.service }}:${TAG}; then
            PUSH_SUCCESS="true"
            echo "âœ… ${{ matrix.service }} æ¨é€æˆåŠŸ"
          else
            echo "âŒ ${{ matrix.service }} æ¨é€å¤±è´¥"
          fi
          
          echo "push_success=${PUSH_SUCCESS}" >> $GITHUB_OUTPUT

      - name: Test image startup
        if: steps.build.outputs.build_success == 'true'
        env:
          HUB: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}
          TAG: ${{ needs.check-trigger.outputs.tag }}
        run: |
          echo "ğŸ§ª æµ‹è¯•é•œåƒå¯åŠ¨èƒ½åŠ›..."
          
          # æµ‹è¯•é•œåƒèƒ½å¦æ­£å¸¸å¯åŠ¨ Java è¿›ç¨‹
          timeout 30s docker run --rm ${HUB}/${{ matrix.service }}:${TAG} java -version && \
          echo "âœ… Java è¿è¡Œæ—¶æµ‹è¯•é€šè¿‡" || \
          echo "âš ï¸ Java è¿è¡Œæ—¶æµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥"

  # æ±‡æ€»æ„å»ºç»“æœ
  build-summary:
    needs: [check-trigger, build-java8-services]
    if: always() && needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create summary
        run: |
          echo "## ğŸ“Š Java 8 ä¿®å¤ç‰ˆæœ¬æ„å»ºç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ”§ ä¿®å¤å†…å®¹:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ› è§£å†³äº† \`java: not found\` é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ ä½¿ç”¨ç¨³å®šçš„ \`openjdk:8-jre-alpine\` åŸºç¡€é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”— æ‰‹åŠ¨ä¸‹è½½å¹¶é…ç½® SkyWalking Agent" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ›¡ï¸ æ·»åŠ äº†ç”¨æˆ·æƒé™å’Œå®‰å…¨é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ç¡®ä¿ Java 8 è¿è¡Œæ—¶ç¯å¢ƒæ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ„å»ºé…ç½®:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ·ï¸ æ ‡ç­¾: \`${{ needs.check-trigger.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ æœåŠ¡: \`${{ needs.check-trigger.outputs.services }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¤ æ¨é€çŠ¶æ€: ${{ needs.check-trigger.outputs.push_enabled == 'true' && 'âœ… å·²æ¨é€' || 'âŒ æœªæ¨é€' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ­ é•œåƒä»“åº“: \`${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ æ„å»ºçš„é•œåƒ" >> $GITHUB_STEP_SUMMARY
          
          SERVICES="${{ needs.check-trigger.outputs.services }}"
          TAG="${{ needs.check-trigger.outputs.tag }}"
          REGISTRY="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}"
          
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          for service in "${SERVICE_ARRAY[@]}"; do
            echo "- \`${REGISTRY}/${service}:${TAG}\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ éƒ¨ç½²å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ›´æ–°éƒ¨ç½²é…ç½®ä½¿ç”¨ä¿®å¤åçš„é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "kubectl patch deployment gateway-service -n sample-services -p '{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"gateway-service\",\"image\":\"${REGISTRY}/gateway-service:${TAG}\"}]}}}}'" >> $GITHUB_STEP_SUMMARY
          echo "kubectl patch deployment songs-service -n sample-services -p '{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"songs-service\",\"image\":\"${REGISTRY}/songs-service:${TAG}\"}]}}}}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æ£€æŸ¥ä¿®å¤æ•ˆæœ" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/gateway-service -n sample-services" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -f deployment/songs-service -n sample-services" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Comment on issue with results
        if: needs.check-trigger.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ needs.build-java8-services.result }}' === 'success';
            
            const summary = `## ğŸ”§ Java 8 ä¿®å¤ç‰ˆæœ¬æ„å»º${success ? 'æˆåŠŸ' : 'å¤±è´¥'}
            
            **ğŸ› è§£å†³çš„é—®é¢˜:**
            - âœ… ä¿®å¤äº† \`java: not found\` é”™è¯¯
            - âœ… ä½¿ç”¨ç¨³å®šçš„ \`openjdk:8-jre-alpine\` åŸºç¡€é•œåƒ
            - âœ… æ­£ç¡®é…ç½®äº† Java 8 è¿è¡Œç¯å¢ƒå’Œ SkyWalking Agent
            
            **ğŸ“¦ ä¿®å¤åçš„é•œåƒ:**
            - \`${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/gateway-service:${{ needs.check-trigger.outputs.tag }}\`
            - \`${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/songs-service:${{ needs.check-trigger.outputs.tag }}\`
            
            **ğŸš€ éƒ¨ç½²ä¿®å¤:**
            \`\`\`bash
            # ä½¿ç”¨ä¿®å¤åçš„é•œåƒæ›´æ–°éƒ¨ç½²
            kubectl patch deployment gateway-service -n sample-services -p '{"spec":{"template":{"spec":{"containers":[{"name":"gateway-service","image":"${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/gateway-service:${{ needs.check-trigger.outputs.tag }}"}]}}}}'
            
            kubectl patch deployment songs-service -n sample-services -p '{"spec":{"template":{"spec":{"containers":[{"name":"songs-service","image":"${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/songs-service:${{ needs.check-trigger.outputs.tag }}"}]}}}}'
            
            # æ£€æŸ¥ä¿®å¤æ•ˆæœ
            kubectl get pods -n sample-services
            kubectl logs -f deployment/gateway-service -n sample-services
            \`\`\`
            
            ---
            *æ„å»ºæ—¶é—´: ${new Date().toISOString()}*
            *æ„å»ºID: [\`${{ github.run_id }}\`](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.issue_number }},
              body: summary
            });

      - name: Check final status
        run: |
          if [[ "${{ needs.build-java8-services.result }}" != "success" ]]; then
            echo "âŒ Java 8 ä¿®å¤ç‰ˆæœ¬æ„å»ºå¤±è´¥"
            exit 1
          else
            echo "âœ… Java 8 ä¿®å¤ç‰ˆæœ¬æ„å»ºæˆåŠŸ!"
            echo "ğŸ‰ ç°åœ¨ Java æœåŠ¡åº”è¯¥å¯ä»¥æ­£å¸¸å¯åŠ¨äº†"
          fi
