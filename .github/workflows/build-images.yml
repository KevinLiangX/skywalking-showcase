# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Build Services

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°mainåˆ†æ”¯ã€PRè¯·æ±‚ã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
  pull_request:
    branches:
      - main
    paths:
      - 'services/**'
  workflow_dispatch:
    inputs:
      services:
        description: 'æŒ‡å®šè¦æ„å»ºçš„æœåŠ¡ (ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºæ„å»ºå…¨éƒ¨)'
        required: false
        default: ''
      push_images:
        description: 'æ˜¯å¦æ¨é€é•œåƒåˆ°ä»“åº“'
        required: false
        default: 'false'
        type: boolean

# ç¯å¢ƒå˜é‡é…ç½®
env:
  HUB: ghcr.io/apache/skywalking-showcase
  ALIYUN_HUB: registry.cn-hangzhou.aliyuncs.com/skywalking-showcase
  DOCKER_BUILDKIT: 1

jobs:
  # æ£€æµ‹å˜æ›´çš„æœåŠ¡
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æµ‹æœåŠ¡å˜æ›´
        id: changes
        run: |
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šäº†æœåŠ¡ï¼Œä½¿ç”¨æŒ‡å®šçš„æœåŠ¡
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.services }}" ]; then
            SERVICES="${{ github.event.inputs.services }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„æœåŠ¡: $SERVICES"
          else
            # æ£€æµ‹servicesç›®å½•ä¸‹å˜æ›´çš„æœåŠ¡
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
            else
              BASE_SHA="HEAD~1"
            fi
            
            CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD)
            SERVICES=$(echo "$CHANGED_FILES" | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
            
            # å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œæ„å»ºæ‰€æœ‰æœåŠ¡
            if [ -z "$SERVICES" ]; then
              SERVICES="gateway-service,songs-service,rating-service,recommendation-service,app,load-gen"
            fi
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°çš„æœåŠ¡: $SERVICES"

      - name: è®¾ç½®æ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          SERVICES="${{ steps.changes.outputs.services }}"
          
          # æ„å»ºJSONçŸ©é˜µ
          MATRIX_JSON="{"
          MATRIX_JSON="$MATRIX_JSON\"include\":["
          
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          FIRST=true
          
          for service in "${SERVICE_ARRAY[@]}"; do
            service=$(echo $service | xargs)  # å»é™¤ç©ºæ ¼
            if [ -z "$service" ]; then continue; fi
            
            if [ "$FIRST" = false ]; then
              MATRIX_JSON="$MATRIX_JSON,"
            fi
            FIRST=false
            
            # æ ¹æ®æœåŠ¡ç±»å‹è®¾ç½®æ„å»ºå‚æ•°
            case $service in
              "gateway-service"|"songs-service")
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$service\",\"language\":\"java\",\"java-version\":\"8\"}"
                ;;
              "rating-service")
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$service\",\"language\":\"go\",\"go-version\":\"1.19\"}"
                ;;
              "recommendation-service"|"load-gen")
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$service\",\"language\":\"python\",\"python-version\":\"3.9\"}"
                ;;
              "app")
                MATRIX_JSON="$MATRIX_JSON{\"service\":\"$service\",\"language\":\"nodejs\",\"node-version\":\"16\"}"
                ;;
            esac
          done
          
          MATRIX_JSON="$MATRIX_JSON]}"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "æ„å»ºçŸ©é˜µ: $MATRIX_JSON"

  # æ„å»ºæœåŠ¡
  build-services:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    permissions:
      contents: read
      packages: write
    
    timeout-minutes: 45
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          submodules: true

      # Javaç¯å¢ƒè®¾ç½®
      - name: è®¾ç½®Javaç¯å¢ƒ
        if: matrix.language == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}

      # Goç¯å¢ƒè®¾ç½®
      - name: è®¾ç½®Goç¯å¢ƒ
        if: matrix.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      # Pythonç¯å¢ƒè®¾ç½®
      - name: è®¾ç½®Pythonç¯å¢ƒ
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # Node.jsç¯å¢ƒè®¾ç½®
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        if: matrix.language == 'nodejs'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'services/${{ matrix.service }}/*/package-lock.json'

      # è®¾ç½®Docker Buildx
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½•åˆ°å®¹å™¨ä»“åº“
      - name: ç™»å½•åˆ°GitHub Container Registry
        if: github.event_name != 'pull_request' || github.event.inputs.push_images == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        if: (github.event_name != 'pull_request' || github.event.inputs.push_images == 'true') && ${{ secrets.ALIYUN_REGISTRY_USERNAME }} != ''
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      # æ„å»ºæœåŠ¡
      - name: æ„å»º ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        run: |
          echo "å¼€å§‹æ„å»ºæœåŠ¡: ${{ matrix.service }}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export TAG=$(git rev-parse --short HEAD)
          export HUB=${{ env.HUB }}
          
          # æ‰§è¡Œæ„å»º
          if [ -f "Makefile" ]; then
            echo "ä½¿ç”¨Makefileæ„å»º..."
            make build || echo "æ„å»ºæ­¥éª¤å®Œæˆï¼ˆæŸäº›æœåŠ¡å¯èƒ½æ²¡æœ‰æ„å»ºæ­¥éª¤ï¼‰"
          else
            echo "æœªæ‰¾åˆ°Makefileï¼Œè·³è¿‡æ„å»ºæ­¥éª¤"
          fi

      # æ„å»ºDockeré•œåƒ
      - name: æ„å»ºDockeré•œåƒ ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        run: |
          echo "æ„å»ºDockeré•œåƒ: ${{ matrix.service }}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export TAG=$(git rev-parse --short HEAD)
          export HUB=${{ env.HUB }}
          export ALIYUN_HUB=${{ env.ALIYUN_HUB }}
          export SW_AGENT_JAVA_IMAGE=ghcr.io/apache/skywalking-java/skywalking-java:26ef911aea908759795bb6f5f2f6be56370d30cc-java8
          export SW_AGENT_GO_IMAGE=ghcr.io/apache/skywalking-go/skywalking-go:154de50628e82e590941585411299459e352317d-go1.19
          
          # æ„å»ºDockeré•œåƒï¼ˆGitHubé•œåƒï¼‰
          if [ -f "Makefile" ]; then
            make docker.build
          else
            echo "æœªæ‰¾åˆ°Makefileï¼Œå°è¯•ç›´æ¥æ„å»ºDockeré•œåƒ"
            docker build -t $HUB/${{ matrix.service }}:$TAG .
          fi
          
          # ä¸ºé˜¿é‡Œäº‘æ„å»ºé•œåƒæ ‡ç­¾
          if [ "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" != "" ]; then
            echo "ä¸ºé˜¿é‡Œäº‘åˆ›å»ºé•œåƒæ ‡ç­¾"
            docker tag $HUB/${{ matrix.service }}:$TAG $ALIYUN_HUB/${{ matrix.service }}:$TAG
            
            # å¦‚æœå­˜åœ¨agentlessç‰ˆæœ¬ï¼Œä¹Ÿåˆ›å»ºå¯¹åº”æ ‡ç­¾
            if docker images | grep -q "$HUB/${{ matrix.service }}:$TAG-agentless"; then
              docker tag $HUB/${{ matrix.service }}:$TAG-agentless $ALIYUN_HUB/${{ matrix.service }}:$TAG-agentless
            fi
          fi

      # æ¨é€Dockeré•œåƒåˆ°GitHub Container Registry
      - name: æ¨é€Dockeré•œåƒåˆ°GitHub ${{ matrix.service }}
        if: (github.event_name != 'pull_request' || github.event.inputs.push_images == 'true') && github.repository == 'apache/skywalking-showcase'
        working-directory: services/${{ matrix.service }}
        run: |
          echo "æ¨é€Dockeré•œåƒåˆ°GitHub: ${{ matrix.service }}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export TAG=$(git rev-parse --short HEAD)
          export HUB=${{ env.HUB }}
          
          # æ¨é€é•œåƒåˆ°GitHub
          if [ -f "Makefile" ]; then
            make docker.push
          else
            docker push $HUB/${{ matrix.service }}:$TAG
          fi

      # æ¨é€Dockeré•œåƒåˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: æ¨é€Dockeré•œåƒåˆ°é˜¿é‡Œäº‘ ${{ matrix.service }}
        if: (github.event_name != 'pull_request' || github.event.inputs.push_images == 'true') && ${{ secrets.ALIYUN_REGISTRY_USERNAME }} != ''
        run: |
          echo "æ¨é€Dockeré•œåƒåˆ°é˜¿é‡Œäº‘: ${{ matrix.service }}"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export TAG=$(git rev-parse --short HEAD)
          export ALIYUN_HUB=${{ env.ALIYUN_HUB }}
          
          # æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘
          docker push $ALIYUN_HUB/${{ matrix.service }}:$TAG
          
          # æ¨é€agentlessç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if docker images | grep -q "$ALIYUN_HUB/${{ matrix.service }}:$TAG-agentless"; then
            docker push $ALIYUN_HUB/${{ matrix.service }}:$TAG-agentless
          fi
          
          echo "âœ… æˆåŠŸæ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡"

      # è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: è¿è¡Œæµ‹è¯• ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        continue-on-error: true
        run: |
          echo "è¿è¡Œæµ‹è¯•: ${{ matrix.service }}"
          
          case "${{ matrix.language }}" in
            "java")
              if [ -f "gradlew" ]; then
                ./gradlew test || echo "æµ‹è¯•å®Œæˆï¼ˆå¯èƒ½æœ‰å¤±è´¥ï¼‰"
              fi
              ;;
            "go")
              if [ -f "go.mod" ]; then
                go test ./... || echo "æµ‹è¯•å®Œæˆï¼ˆå¯èƒ½æœ‰å¤±è´¥ï¼‰"
              fi
              ;;
            "python")
              if [ -f "requirements-test.txt" ]; then
                pip install -r requirements-test.txt
                python -m pytest || echo "æµ‹è¯•å®Œæˆï¼ˆå¯èƒ½æœ‰å¤±è´¥ï¼‰"
              fi
              ;;
            "nodejs")
              if [ -f "package.json" ]; then
                npm test || echo "æµ‹è¯•å®Œæˆï¼ˆå¯èƒ½æœ‰å¤±è´¥ï¼‰"
              fi
              ;;
          esac

  # æ„å»ºæ‘˜è¦
  build-summary:
    needs: [detect-changes, build-services]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: æ„å»ºæ‘˜è¦
        run: |
          echo "## ğŸš€ æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ£€æµ‹åˆ°çš„æœåŠ¡:** ${{ needs.detect-changes.outputs.services }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-services.result }}" = "success" ]; then
            echo "âœ… **æ‰€æœ‰æœåŠ¡æ„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-services.result }}" = "failure" ]; then
            echo "âŒ **éƒ¨åˆ†æœåŠ¡æ„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **æ„å»ºçŠ¶æ€:** ${{ needs.build-services.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**æäº¤:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
