# SkyWalking Showcase é•œåƒæ„å»ºå’Œæ¨é€å·¥ä½œæµ
# æ”¯æŒæ‰‹åŠ¨æ‰§è¡Œå’Œissueè¯„è®ºè§¦å‘ï¼Œæ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡

name: Build and Push to Alibaba Cloud

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨æ‰§è¡Œã€æ¨é€åˆ°ä¸»åˆ†æ”¯ã€PR
on:
  workflow_dispatch:
    inputs:
      services:
        description: 'è¦æ„å»ºçš„æœåŠ¡ (ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºæ„å»ºæ‰€æœ‰æœåŠ¡)'
        required: false
        default: ''
      tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: 'latest'
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡'
        type: boolean
        required: false
        default: true
  push:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'Dockerfile*'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'services/**'
      - 'Dockerfile*'

# ç¯å¢ƒå˜é‡é…ç½®
env:
  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}  # ä¾‹å¦‚: your-registry.cn-hangzhou.cr.aliyuncs.com
  ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }} # ä¾‹å¦‚: skywalking-showcase
  
  # SkyWalking Agentç‰ˆæœ¬é…ç½®
  SW_AGENT_NODEJS_FRONTEND_VERSION: dce0d5b39ab95b8062031bc74e6f7a191f08e186
  SW_AGENT_NODEJS_BACKEND_VERSION: 59ef1aed6a404e2e8afffbb4b81ea849ae4f3026
  SW_AGENT_GO_IMAGE: ghcr.io/apache/skywalking-go/skywalking-go:154de50628e82e590941585411299459e352317d-go1.19
  SW_AGENT_JAVA_IMAGE: ghcr.io/apache/skywalking-java/skywalking-java:26ef911aea908759795bb6f5f2f6be56370d30cc-java8
  
  # æ„å»ºé…ç½®
  DOCKER_BUILDKIT: 1

# æƒé™é…ç½®
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # å‡†å¤‡æ„å»ºçŸ©é˜µ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®æ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          # å®šä¹‰æ‰€æœ‰å¯ç”¨çš„æœåŠ¡ï¼ˆä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ï¼‰
          ALL_SERVICES='["app-frontend", "app-server", "gateway-service", "rating-service", "recommendation-service", "songs-service", "load-gen"]'
          
          # æ£€æŸ¥æ˜¯å¦æŒ‡å®šäº†ç‰¹å®šæœåŠ¡
          if [ "${{ github.event.inputs.services }}" != "" ]; then
            # æ‰‹åŠ¨æŒ‡å®šçš„æœåŠ¡
            SERVICES=$(echo '${{ github.event.inputs.services }}' | jq -R 'split(",") | map(select(length > 0) | gsub("^\\s+|\\s+$"; ""))')
            echo "æ„å»ºæŒ‡å®šæœåŠ¡: $SERVICES"
          else
            # æ£€æŸ¥æ–‡ä»¶å˜æ›´æ¥å†³å®šæ„å»ºå“ªäº›æœåŠ¡
            if [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
              CHANGED_SERVICES='[]'
              
              # æ£€æŸ¥æ¯ä¸ªæœåŠ¡æ˜¯å¦æœ‰å˜æ›´
              for service_path in "app" "gateway-service" "rating-service" "recommendation-service" "songs-service" "load-gen"; do
                if git diff --name-only HEAD~1 HEAD | grep -q "^services/$service_path/"; then
                  if [ "$service_path" = "app" ]; then
                    # æ£€æŸ¥appå­æœåŠ¡çš„å…·ä½“å˜æ›´
                    if git diff --name-only HEAD~1 HEAD | grep -q "^services/app/frontend/"; then
                      CHANGED_SERVICES=$(echo $CHANGED_SERVICES | jq ". + [\"app-frontend\"]")
                    fi
                    if git diff --name-only HEAD~1 HEAD | grep -q "^services/app/server/"; then
                      CHANGED_SERVICES=$(echo $CHANGED_SERVICES | jq ". + [\"app-server\"]")
                    fi
                  else
                    CHANGED_SERVICES=$(echo $CHANGED_SERVICES | jq ". + [\"$service_path\"]")
                  fi
                fi
              done
              
              # å¦‚æœæ²¡æœ‰æœåŠ¡å˜æ›´ï¼Œæ„å»ºæ‰€æœ‰æœåŠ¡
              if [ "$CHANGED_SERVICES" = "[]" ]; then
                SERVICES=$ALL_SERVICES
                echo "æ²¡æœ‰æ£€æµ‹åˆ°æœåŠ¡å˜æ›´ï¼Œæ„å»ºæ‰€æœ‰æœåŠ¡"
              else
                SERVICES=$CHANGED_SERVICES
                echo "æ£€æµ‹åˆ°æœåŠ¡å˜æ›´: $SERVICES"
              fi
            else
              # é»˜è®¤æ„å»ºæ‰€æœ‰æœåŠ¡
              SERVICES=$ALL_SERVICES
              echo "æ„å»ºæ‰€æœ‰æœåŠ¡"
            fi
          fi
          
          echo "matrix=$SERVICES" >> $GITHUB_OUTPUT
          
      - name: è®¾ç½®é•œåƒæ ‡ç­¾
        id: set-tag
        run: |
          if [ "${{ github.event.inputs.tag }}" != "" ]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            TAG="pr-${{ github.event.number }}"
          else
            TAG="${GITHUB_SHA:0:8}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ä½¿ç”¨é•œåƒæ ‡ç­¾: $TAG"

  # æ„å»ºå’Œæ¨é€é•œåƒ
  build:
    needs: prepare
    if: needs.prepare.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ„å»ºSkyWalking Agent
          
      - name: è®¾ç½®Javaç¯å¢ƒ (ä»…JavaæœåŠ¡)
        if: contains(fromJson('["gateway-service", "songs-service"]'), matrix.service)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: æ„å»ºJavaåº”ç”¨ (ä»…JavaæœåŠ¡)
        if: contains(fromJson('["gateway-service", "songs-service"]'), matrix.service)
        run: |
          cd services/${{ matrix.service }}
          chmod +x gradlew
          ./gradlew build -x test
          
      - name: è®¾ç½®Node.jsç¯å¢ƒ (ä»…Node.jsæœåŠ¡)
        if: contains(fromJson('["app-frontend", "app-server"]'), matrix.service)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: services/app/*/package-lock.json
          
      - name: è®¾ç½®Pythonç¯å¢ƒ (ä»…PythonæœåŠ¡)
        if: contains(fromJson('["recommendation-service", "load-gen"]'), matrix.service)
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: è®¾ç½®Goç¯å¢ƒ (ä»…GoæœåŠ¡)
        if: matrix.service == 'rating-service'
        uses: actions/setup-go@v4
        with:
          go-version: '1.19'
          
      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          
      - name: ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        if: github.event.inputs.push_to_registry != 'false' && (github.event_name != 'pull_request')
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
          
      - name: æå–é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ steps.build-config.outputs.image_name }}
          tags: |
            type=raw,value=${{ needs.prepare.outputs.tag }}
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            
      - name: è®¾ç½®æ„å»ºè·¯å¾„å’ŒDockerfile
        id: build-config
        run: |
          case "${{ matrix.service }}" in
            "app-frontend")
              echo "context=./services/app/frontend" >> $GITHUB_OUTPUT
              echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
              echo "image_name=app/frontend" >> $GITHUB_OUTPUT
              ;;
            "app-server")
              echo "context=./services/app/server" >> $GITHUB_OUTPUT
              echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
              echo "image_name=app/server" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "context=./services/${{ matrix.service }}" >> $GITHUB_OUTPUT
              echo "dockerfile=Dockerfile" >> $GITHUB_OUTPUT
              echo "image_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
              ;;
          esac
          
      - name: æ„å»ºé•œåƒ (ä»…æµ‹è¯•)
        if: github.event.inputs.push_to_registry == 'false' || github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.build-config.outputs.context }}
          file: ${{ steps.build-config.outputs.context }}/${{ steps.build-config.outputs.dockerfile }}
          platforms: linux/amd64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            SW_AGENT_NODEJS_FRONTEND_VERSION=${{ env.SW_AGENT_NODEJS_FRONTEND_VERSION }}
            SW_AGENT_NODEJS_BACKEND_VERSION=${{ env.SW_AGENT_NODEJS_BACKEND_VERSION }}
            SW_AGENT_GO_IMAGE=${{ env.SW_AGENT_GO_IMAGE }}
            SW_AGENT_JAVA_IMAGE=${{ env.SW_AGENT_JAVA_IMAGE }}
            
      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        if: github.event.inputs.push_to_registry != 'false' && github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        id: build
        with:
          context: ${{ steps.build-config.outputs.context }}
          file: ${{ steps.build-config.outputs.context }}/${{ steps.build-config.outputs.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            SW_AGENT_NODEJS_FRONTEND_VERSION=${{ env.SW_AGENT_NODEJS_FRONTEND_VERSION }}
            SW_AGENT_NODEJS_BACKEND_VERSION=${{ env.SW_AGENT_NODEJS_BACKEND_VERSION }}
            SW_AGENT_GO_IMAGE=${{ env.SW_AGENT_GO_IMAGE }}
            SW_AGENT_JAVA_IMAGE=${{ env.SW_AGENT_JAVA_IMAGE }}
            
      - name: è¾“å‡ºæ„å»ºç»“æœ
        run: |
          echo "## ğŸ³ é•œåƒæ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æœåŠ¡:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ ‡ç­¾:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒ:** ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ steps.build-config.outputs.image_name }}:${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.push_to_registry }}" != "false" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "**çŠ¶æ€:** âœ… å·²æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** ğŸ” ä»…æ„å»ºæµ‹è¯•ï¼Œæœªæ¨é€" >> $GITHUB_STEP_SUMMARY
          fi

  # æ±‡æ€»æ„å»ºç»“æœ
  summary:
    needs: [prepare, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        run: |
          echo "# ğŸš€ SkyWalking Showcase æ„å»ºæŠ¥å‘Š" > build-report.md
          echo "" >> build-report.md
          echo "**æ„å»ºæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> build-report.md
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> build-report.md
          echo "**åˆ†æ”¯/PR:** ${{ github.ref_name }}" >> build-report.md
          echo "**æäº¤:** ${{ github.sha }}" >> build-report.md
          echo "**é•œåƒæ ‡ç­¾:** ${{ needs.prepare.outputs.tag }}" >> build-report.md
          echo "" >> build-report.md
          
          # æ„å»ºçŠ¶æ€
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "## âœ… æ„å»ºæˆåŠŸ" >> build-report.md
            echo "" >> build-report.md
            echo "æ‰€æœ‰æœåŠ¡é•œåƒæ„å»ºå®Œæˆï¼" >> build-report.md
          elif [ "${{ needs.build.result }}" = "failure" ]; then
            echo "## âŒ æ„å»ºå¤±è´¥" >> build-report.md
            echo "" >> build-report.md
            echo "éƒ¨åˆ†æœåŠ¡æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ã€‚" >> build-report.md
          else
            echo "## âš ï¸ æ„å»ºè¢«è·³è¿‡" >> build-report.md
            echo "" >> build-report.md
            echo "æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æ„å»ºçš„æœåŠ¡å˜æ›´ã€‚" >> build-report.md
          fi
          
          echo "" >> build-report.md
          echo "## ğŸ“‹ æ„å»ºçš„æœåŠ¡" >> build-report.md
          echo "" >> build-report.md
          
          # æ˜¾ç¤ºæ„å»ºçš„æœåŠ¡åˆ—è¡¨
          SERVICES='${{ needs.prepare.outputs.matrix }}'
          if [ "$SERVICES" != "[]" ]; then
            echo "$SERVICES" | jq -r '.[] | "- " + .'
          else
            echo "- æ— æœåŠ¡éœ€è¦æ„å»º"
          fi >> build-report.md
          
          echo "" >> build-report.md
          echo "## ğŸ”— é•œåƒåœ°å€" >> build-report.md
          echo "" >> build-report.md
          
          if [ "${{ github.event.inputs.push_to_registry }}" != "false" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "é•œåƒå·²æ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨æœåŠ¡ï¼š" >> build-report.md
            echo "" >> build-report.md
            echo "\`\`\`" >> build-report.md
            echo "$SERVICES" | jq -r '.[] | if . == "app-frontend" then "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/app/frontend:${{ needs.prepare.outputs.tag }}" elif . == "app-server" then "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/app/server:${{ needs.prepare.outputs.tag }}" else "${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/" + . + ":${{ needs.prepare.outputs.tag }}" end' >> build-report.md
            echo "\`\`\`" >> build-report.md
          else
            echo "é•œåƒä»…æ„å»ºæµ‹è¯•ï¼Œæœªæ¨é€åˆ°æ³¨å†Œè¡¨ã€‚" >> build-report.md
          fi
          
          # è¾“å‡ºåˆ°GitHub Summary
          cat build-report.md >> $GITHUB_STEP_SUMMARY
          
      - name: ä¿å­˜æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30

  # é€šçŸ¥æ„å»ºç»“æœåˆ°Issue (å¦‚æœæ˜¯é€šè¿‡issueè§¦å‘çš„)
  notify:
    needs: [prepare, build, summary]
    if: always() && github.event.issue.number
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è½½æ„å»ºæŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: build-report
          
      - name: è¯„è®ºåˆ°Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('build-report.md', 'utf8');
            
            const comment = `${report}
            
            ---
            
            ğŸ’¡ **ä½¿ç”¨æç¤º:**
            - ä½¿ç”¨ \`/build\` å‘½ä»¤é‡æ–°æ„å»ºæ‰€æœ‰æœåŠ¡
            - ä½¿ç”¨ \`/build service1,service2\` æ„å»ºæŒ‡å®šæœåŠ¡
            - ä½¿ç”¨ \`/build --tag custom-tag\` æŒ‡å®šé•œåƒæ ‡ç­¾
            
            ğŸ”— [æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
